#!/bin/bash

print_usage() {
    echo "Usage: $0 -i input_file -p parts -t timestamp1 timestamp2 ..."
    exit 1
}

INPUT=""
PARTS=0
TIMESTAMPS=()
PARSE_TIMESTAMPS=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    -i) INPUT="$2"; shift 2 ;;
    -p) PARTS="$2"; shift 2 ;;
    -t) PARSE_TIMESTAMPS=1; shift ;;
    *)  [[ $PARSE_TIMESTAMPS -eq 1 ]] && TIMESTAMPS+=("$1") && shift || print_usage ;;
  esac
done

[[ -z "$INPUT" || "$PARTS" -le 0 ]] && print_usage
[[ ${#TIMESTAMPS[@]} -ne $((PARTS - 1)) ]] && print_usage

# Convert HH:MM:SS to seconds
to_sec() {
    IFS=: read -r h m s <<< "$1"
    echo $((10#$h*3600 + 10#$m*60 + 10#$s))
}

# Build ffmpeg command
CMD=(ffmpeg -hide_banner -loglevel error -i "$INPUT")

START_SEC=0
for i in "${!TIMESTAMPS[@]}"; do
  END_SEC=$(to_sec "${TIMESTAMPS[$i]}")
  DURATION=$((END_SEC - START_SEC))
  CMD+=(-map 0 -ss "$START_SEC" -t "$DURATION" -c copy "part$((i+1)).mp4")
  START_SEC=$END_SEC
done

# Last part until end
CMD+=(-map 0 -ss "$START_SEC" -c copy "part$PARTS.mp4")

echo "▶️ Running optimized split..."
"${CMD[@]}"
echo "✅ Done splitting '$INPUT' into $PARTS parts."
